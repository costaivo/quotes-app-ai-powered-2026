name: Validate Branch Protection

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate-protection:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR Requirements
        run: |
          echo "ðŸ” Validating Pull Request requirements..."
          
          # Check if PR has required labels (if any)
          if [ -z "${{ github.event.pull_request.labels }}" ]; then
            echo "âš ï¸  No labels found on PR. Consider adding labels for better organization."
          fi
          
          # Check if PR has description
          if [ -z "${{ github.event.pull_request.body }}" ]; then
            echo "âŒ PR description is empty. Please provide a description of your changes."
            exit 1
          fi
          
          # Check if PR is from a fork (security consideration)
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "âš ï¸  PR is from a fork. Extra security review may be required."
          fi
          
          echo "âœ… PR validation passed!"

      - name: Check Required Files
        run: |
          echo "ðŸ“‹ Checking for required files..."
          
          # Check if PR template exists
          if [ ! -f ".github/pull_request_template.md" ]; then
            echo "âŒ Pull request template not found!"
            exit 1
          fi
          
          # Check if CODEOWNERS exists
          if [ ! -f ".github/CODEOWNERS" ]; then
            echo "âŒ CODEOWNERS file not found!"
            exit 1
          fi
          
          # Check if CI workflow exists
          if [ ! -f ".github/workflows/ci.yml" ]; then
            echo "âŒ CI workflow not found!"
            exit 1
          fi
          
          echo "âœ… All required files present!"

      - name: Validate CI Configuration
        run: |
          echo "ðŸ”§ Validating CI configuration..."
          
          # Check if CI workflow has required jobs
          if ! grep -q "test-backend" .github/workflows/ci.yml; then
            echo "âŒ test-backend job not found in CI workflow!"
            exit 1
          fi
          
          if ! grep -q "build-frontend" .github/workflows/ci.yml; then
            echo "âŒ build-frontend job not found in CI workflow!"
            exit 1
          fi
          
          # Check if coverage reporting is configured
          if ! grep -q "coverage" .github/workflows/ci.yml; then
            echo "âš ï¸  Coverage reporting not found in CI workflow!"
          fi
          
          echo "âœ… CI configuration validation passed!"

      - name: Check Test Coverage
        run: |
          echo "ðŸ“Š Checking test coverage configuration..."
          
          # Check if Jest config has coverage thresholds
          if [ -f "app/be/jest.config.js" ]; then
            if ! grep -q "coverageThreshold" app/be/jest.config.js; then
              echo "âŒ Coverage thresholds not configured in Jest!"
              exit 1
            fi
            echo "âœ… Jest coverage thresholds configured!"
          else
            echo "âš ï¸  Jest configuration not found!"
          fi

      - name: Summary
        run: |
          echo "ðŸŽ‰ Branch protection validation completed!"
          echo ""
          echo "ðŸ“ Next steps for repository administrators:"
          echo "1. Go to repository Settings > Branches"
          echo "2. Add branch protection rule for 'main' branch"
          echo "3. Configure required status checks:"
          echo "   - test-backend"
          echo "   - build-frontend"
          echo "   - validate-protection (this workflow)"
          echo "4. Enable 'Require pull request reviews before merging'"
          echo "5. Enable 'Require branches to be up to date before merging'"
          echo "6. Enable 'Require linear history'"
          echo ""
          echo "ðŸ“– See docs/setup/branch-protection-setup.md for detailed instructions."
